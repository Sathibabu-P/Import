// Generated by CoffeeScript 1.4.0
(function() {
  var root, thisApp;

  root = typeof global !== "undefined" && global !== null ? global : window;

  thisApp = root.thisApp;


thisApp.controller("WelcomeHomeCtrl", function(Auth,$scope,$http,$location) { 


      Auth.currentUser().then(function(user) {           
            $scope.email = user.email
         
        }, function(error) {          
             $location.path('/');
        });


          $scope.logout = function (){

           var config = {
            headers: {
                'X-HTTP-Method-Override': 'DELETE'
                  }
              };
              // Log in user...
              // ...
              Auth.logout(config).then(function(oldUser) {
                  // alert(oldUser.email + "you're signed out now.");
                   $location.path('/');
              }, function(error) {
                  // An error occurred logging out.

              });

              

        };


  });



  thisApp.controller("WelcomeCtrl", function(Auth,$scope,$http,$location) {

      var config = {
            headers: {
                'X-HTTP-Method-Override': 'POST'
            }
      };
   

  	 $scope.user={};
     $scope.error_show = false;
     $scope.social_show = false;
     $scope.validation_show = false;
     $scope.uservalidation = false;
     $scope.emailvalidation = false;
    
  	  $scope.login = function (){

       var credentials = {
            email:  $scope.user.email,
            password:  $scope.user.password
        };
        var config = {
            headers: {
                'X-HTTP-Method-Override': 'POST'
            }
        };

      

        Auth.login(credentials, config).then(function(user) {
            // console.log(user); // => {id: 1, ect: '...'}

            $location.path('/home');
        }, function(error) {
            // Authentication failed...
            if(!$scope.error_show)
            $scope.validation_show = true;
            
        });

        // $scope.$on('devise:login', function(event, currentUser) {
        //     // after a login, a hard refresh, a new tab
        //     $scope.user={};
        //     $location.path('/store');
        // });

        // $scope.$on('devise:new-session', function(event, currentUser) {
        //     // user logged in by Auth.login({...})
        // });


    };


    $scope.register = function (){

        $scope.validation_show = false;
        $scope.emailvalidation = false;
        $scope.passwordvalidation = false;

       var credentials = {
            email:  $scope.user.email,
            password:  $scope.user.password,            
        };
        var config = {
            headers: {
                'X-HTTP-Method-Override': 'POST'
            }
        };

        Auth.register(credentials, config).then(function(registeredUser) {
          
            Auth.login(credentials, config);
           
        }, function(error) {
            // Registration failed...

          //  $scope.errors.push(error);
          if(error.data.errors.email){

              if(error.data.errors.email == "has already been taken"){

                 $scope.validation_show = false;
                 $scope.emailvalidation = false;

              } else if(error.data.errors.email == "is invalid"){

                 $scope.validation_show = true;
                 $scope.emailvalidation = true;

              }
            
          }else if(error.data.errors.password){
              
              $scope.validation_show = true;
              $scope.passwordvalidation = true;

          }
        });

     };


      $scope.NewUser = function (){

      if($scope.user.email){
         $http.post('/checkuser', {email:$scope.user.email}).
        success(function(data) {
          if(data < 1){
            $scope.error_show = true
            $scope.social_show = false
            $scope.validation_show = false;
          }
          
          else {
            $scope.social_show = true
            $scope.error_show = false  
          }
          

        }).
        error(function(data) {
          //
        }); 
      }
           
      };


       $scope.ResetPassword = function (){

      if($scope.user.email){
         $http.post('/users/password', {email:$scope.user.email}).
        success(function(data) {   
          
          console.log(data);
        }).
        error(function(data) {
          //
        }); 
      }
           
      };


      // $scope.SubmitForm = function() {
      //  if(error_show){
      //   $('#new_user').submit();
      //  }
      // }


      $scope.RegisteredUser = function (){

        $scope.validation_show = false;
        $scope.emailvalidation = false;
        $scope.passwordvalidation = false;


      if($scope.user.email){

        var regexp = /^[a-z]+[a-z0-9._]+@[a-z]+\.[a-z.]{2,5}$/;
      

          if(regexp.test($scope.user.email)) {

              $http.post('/checkuser', {email:$scope.user.email}).
                    success(function(data) {
                      if(data > 0)
                      $scope.error_show = true
                      else 
                      $scope.error_show = false  

                    }).
                    error(function(data) {
                      //
                    });

          }else{
            $scope.validation_show = true;
            $scope.emailvalidation = true;
          }
          


      }       
      };


 

  });
 

}).call(this);
