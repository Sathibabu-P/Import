// Generated by CoffeeScript 1.4.0
(function() {
  var root, thisApp;

  root = typeof global !== "undefined" && global !== null ? global : window;

  thisApp = root.thisApp;


thisApp.controller("WelcomeHomeCtrl", function(Auth,$scope,$http,$location) { 


      Auth.currentUser().then(function(user) {           
            $scope.email = user.email
            $scope.display_name = user.display_name         
        }, function(error) {          
             $location.path('/');
      });


      


          $scope.logout = function (){

           var config = {
            headers: {
                'X-HTTP-Method-Override': 'DELETE'
                  }
              };
              // Log in user...
              // ...
              Auth.logout(config).then(function(oldUser) {
                  // alert(oldUser.email + "you're signed out now.");
                   $location.path('/');
              }, function(error) {
                  // An error occurred logging out.

              });

              

        };


  });



  thisApp.controller("WelcomeCtrl", function(Auth,$scope,$http,$location,$auth,$routeParams) {

      var config = {
            headers: {
                'X-HTTP-Method-Override': 'POST'
            }
      };
      
       $scope.authenticate = function(provider) {        
        $auth.authenticate(provider)
          .then(function() {
           
             $location.path('/home');
          })
          .catch(function(error) {
            if (error.error) {
              // Popup error - invalid redirect_uri, pressed cancel button, etc.
              console.log(error.error);
            } else if (error.data) {
              // HTTP response error from server
              console.log(error.data.message, error.status);
            } else {
              console.log(error);
            }
          });
      };



  	 $scope.user={};
     $scope.error_show = false;
     $scope.social_show = false;
     $scope.validation_show = false;
     $scope.uservalidation = false;
     $scope.emailvalidation = false;
    
  	  $scope.login = function (){

       var credentials = {
            email:  $scope.user.email,
            password:  $scope.user.password
        };
        var config = {
            headers: {
                'X-HTTP-Method-Override': 'POST'
            }
        };

      

        Auth.login(credentials, config).then(function(user) {
            // console.log(user); // => {id: 1, ect: '...'}

            $location.path('/home');
        }, function(error) {
            // Authentication failed...
            if(!$scope.error_show)
            $scope.validation_show = true;
            
        });

       


    };


      $scope.PasswordLength = function () {

        if(!$scope.user.password || $scope.user.password.length < 6 ){
            $scope.length_error_show = true
            return false
        } else {
          $scope.length_error_show = false
          return true
        }
           
      };


      $scope.PasswordMatch = function (){

        var result = $scope.PasswordLength();

        if(!result || $scope.user.password !=  $scope.user.password_confirmation){
            $scope.mismatch_error_show = true
            return false
        } else {
          $scope.mismatch_error_show = false
           return true
        }
           
      };




  $scope.change_password = function() {

    
     var result = $scope.PasswordMatch();
     
    
    var credentials = {  
            token: $routeParams.token,         
            password:  $scope.user.password,
            password_confirmation:  $scope.user.password_confirmation
        };
         if(result){
           $http({
            method: 'PUT',
            url: '/users/password',
            data: credentials,        
            }).then(function successCallback(response) {
              $location.path('/');
            }, function errorCallback(response) {
              $location.path('/reset/'+token);
            });
         }
       


   
  };





    $scope.register = function (){

        $scope.validation_show = false;
        $scope.emailvalidation = false;
        $scope.passwordvalidation = false;
        $scope.mismatch_error_show = false;
         $scope.length_error_show = false;

       var credentials = {
            email:  $scope.user.email,
            password:  $scope.user.password,            
        };
        var config = {
            headers: {
                'X-HTTP-Method-Override': 'POST'
            }
        };

        Auth.register(credentials, config).then(function(registeredUser) {
          
            // Auth.login(credentials, config);
             $location.path('/');
           
        }, function(error) {
            // Registration failed...

          //  $scope.errors.push(error);
          if(error.data.errors.email){

              if(error.data.errors.email == "has already been taken"){

                 $scope.validation_show = false;
                 $scope.emailvalidation = false;

              } else if(error.data.errors.email == "is invalid"){

                 $scope.validation_show = true;
                 $scope.emailvalidation = true;

              }
            
          }else if(error.data.errors.password){
              
              $scope.validation_show = true;
              $scope.passwordvalidation = true;

          }
        });

     };


      $scope.NewUser = function (){

      if($scope.user.email){
         $http.post('/checkuser', {email:$scope.user.email}).
        success(function(data) {
          if(data < 1){
            $scope.error_show = true
            $scope.social_show = false
            $scope.validation_show = false;
          }
          
          else {
            $scope.social_show = true
            $scope.error_show = false  
          }
          

        }).
        error(function(data) {
          //
        }); 
      }
           
      };

       $scope.ResetPassword = function (){

      if($scope.user.email){
         $http.post('/users/password', {email:$scope.user.email}).
        success(function(data) {   
          
          console.log(data);
        }).
        error(function(data) {
          //
        }); 
      }
           
      };



 

      // $scope.SubmitForm = function() {
      //  if(error_show){
      //   $('#new_user').submit();
      //  }
      // }


      $scope.RegisteredUser = function (){

        $scope.validation_show = false;
        $scope.emailvalidation = false;
        $scope.passwordvalidation = false;


      if($scope.user.email){

        var regexp = /^[a-z]+[a-z0-9._]+@[a-z]+\.[a-z.]{2,5}$/;
      

          if(regexp.test($scope.user.email)) {

              $http.post('/checkuser', {email:$scope.user.email}).
                    success(function(data) {
                      if(data > 0)
                      $scope.error_show = true
                      else 
                      $scope.error_show = false  

                    }).
                    error(function(data) {
                      //
                    });

          }else{
            $scope.validation_show = true;
            $scope.emailvalidation = true;
          }
          


      }       
      };


 

  });
 

}).call(this);
